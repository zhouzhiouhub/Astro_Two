---
import { t, type Locale } from "@/lib/i18n";
const { lang } = Astro.props as { lang: Locale };

const placeholder = t("common", "search_placeholder", lang);
const hintText = t("common", "search_hint", lang);
const emptyText = t("common", "search_no_results", lang);
const noScopeText = t("common", "search_no_scope", lang);
---
<div
  id="search-overlay"
  class="fixed inset-0 hidden z-[1000]"
  data-no-results={emptyText}
  data-no-scope={noScopeText}
>
  <div id="search-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  <div class="relative mx-auto mt-24 w-[92%] max-w-3xl rounded-lg border border-[var(--color-border)] bg-[var(--color-bg)] shadow-lg">
    <div class="flex items-center justify-between px-4 py-3 border-b border-[var(--color-border)]">
      <div class="text-sm text-[var(--color-muted)]">{t('common','search', lang)}</div>
      <button id="search-close" aria-label="Close" class="text-[var(--color-muted)] hover:text-[var(--color-fg)]">âœ•</button>
    </div>
    <div class="p-4 space-y-4">
      <div>
        <label class="block">
          <span class="sr-only">{t('common','search', lang)}</span>
          <input
            id="search-input"
            type="search"
            placeholder={placeholder}
            class="w-full rounded-lg border border-[var(--color-border)] bg-[var(--color-bg-soft)] px-4 py-3 text-sm outline-none focus:border-[var(--color-primary)]"
          />
        </label>
      </div>
      <p id="search-hint" class="text-xs text-[var(--color-muted)]">{hintText}</p>
      <ul id="search-results" class="space-y-2"></ul>
      <p id="search-empty" class="hidden text-sm text-[var(--color-muted)]">{emptyText}</p>
    </div>
  </div>
</div>

<script>
  // @ts-nocheck
  const overlay = document.getElementById('search-overlay');
  if (overlay && !overlay.dataset.initialized) {
    overlay.dataset.initialized = 'true';

    const closeBtn = document.getElementById('search-close');
    const backdrop = document.getElementById('search-backdrop');
    const input = document.getElementById('search-input');
    const results = document.getElementById('search-results');
    const hint = document.getElementById('search-hint');
    const empty = document.getElementById('search-empty');
    const noResultsText = overlay.dataset.noResults || '';
    const noScopeText = overlay.dataset.noScope || '';

    let captured = false;
    let collection = [];
    let highlightTimer = null;

    function showOverlay() {
      overlay.classList.remove('hidden');
    }

    function hideOverlay() {
      overlay.classList.add('hidden');
      if (input) {
        input.value = '';
        input.disabled = false;
      }
      results && (results.innerHTML = '');
      empty && (empty.hidden = true, empty.textContent = noResultsText);
      if (hint) hint.hidden = false;
      captured = false;
      collection = [];
    }

    function collectItems() {
      if (captured) return;
      const nodes = Array.from(document.querySelectorAll('[data-search-item]'));
      collection = nodes.map((node) => {
        const title = (node.getAttribute('data-search-title') || '').trim() || node.querySelector('[data-search-title]')?.textContent?.trim() || node.textContent.trim().slice(0, 120);
        const description = (node.getAttribute('data-search-description') || '').trim();
        const keywordsRaw = node.getAttribute('data-search-keywords') || node.textContent || '';
        const anchor = node.getAttribute('data-search-anchor') || node.id || '';
        const link = node.getAttribute('data-search-link') || '';
        return {
          node,
          title,
          description,
          keywords: keywordsRaw.toLowerCase(),
          anchor,
          link,
        };
      }).filter((item) => item.title);
      captured = true;

      if (collection.length === 0) {
        if (input) input.disabled = true;
        if (hint) hint.hidden = true;
        if (empty) {
          empty.hidden = false;
          empty.textContent = noScopeText;
        }
      } else {
        if (hint) hint.hidden = false;
        if (input) input.disabled = false;
        if (empty) {
          empty.hidden = true;
          empty.textContent = noResultsText;
        }
      }
    }

    function highlight(node) {
      if (!node) return;
      const previousOutline = node.style.outline;
      const previousOffset = node.style.outlineOffset;
      node.style.outline = '2px solid var(--color-primary)';
      node.style.outlineOffset = '4px';
      clearTimeout(highlightTimer);
      highlightTimer = setTimeout(() => {
        node.style.outline = previousOutline;
        node.style.outlineOffset = previousOffset;
      }, 1600);
    }

    function navigateTo(item) {
      hideOverlay();
      if (item.anchor) {
        const target = document.getElementById(item.anchor);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          highlight(target);
          return;
        }
      }
      if (item.node) {
        item.node.scrollIntoView({ behavior: 'smooth', block: 'start' });
        highlight(item.node);
      }
      if (item.link && !item.link.startsWith('#')) {
        window.location.href = item.link;
      }
    }

    function renderResults(query) {
      if (!results || collection.length === 0) return;
      const value = query.trim().toLowerCase();
      const matches = value ? collection.filter((item) => item.keywords.includes(value)) : collection;
      results.innerHTML = '';

      if (matches.length === 0) {
        if (empty) {
          empty.textContent = noResultsText;
          empty.hidden = false;
        }
        return;
      }

      if (empty) empty.hidden = true;

      matches.forEach((item) => {
        const li = document.createElement('li');
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'group w-full rounded-xl border border-[var(--color-border)] bg-[var(--color-bg-soft)] px-4 py-3 text-left transition hover:border-[var(--color-primary)] hover:bg-[var(--color-bg)]';

        const title = document.createElement('div');
        title.className = 'text-sm font-semibold text-[var(--color-fg)]';
        title.textContent = item.title;

        button.appendChild(title);

        if (item.description) {
          const desc = document.createElement('div');
          desc.className = 'mt-1 text-xs text-[var(--color-muted)]';
          desc.style.display = '-webkit-box';
          desc.style.webkitBoxOrient = 'vertical';
          desc.style.webkitLineClamp = '2';
          desc.style.overflow = 'hidden';
          desc.textContent = item.description;
          button.appendChild(desc);
        }

        button.addEventListener('click', () => navigateTo(item));
        li.appendChild(button);
        results.appendChild(li);
      });
    }

    function openLocalSearch() {
      showOverlay();
      collectItems();
      renderResults(input ? input.value : '');
      if (input && !input.disabled) {
        requestAnimationFrame(() => {
          try { input.focus({ preventScroll: true }); }
          catch (_) { input.focus(); }
        });
      }
    }

    window.addEventListener('open-search', () => {
      openLocalSearch();
    });

    closeBtn?.addEventListener('click', hideOverlay);
    backdrop?.addEventListener('click', hideOverlay);
    window.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && !overlay.classList.contains('hidden')) {
        hideOverlay();
      }
    });

    input?.addEventListener('input', (event) => {
      renderResults(event.target.value || '');
    });
  }
</script>
