---
import { t, type Locale, pathWithLocale } from "@/lib/i18n";
import LocaleSwitcher from "./LocaleSwitcher.astro";
const { lang } = Astro.props as { lang: Locale };
const currentPath = Astro.url.pathname;
---
<header class="container relative z-50 flex items-center justify-between py-6">
  <a href={`/${lang}`} class="flex items-center gap-2">
    <img src="/logo.svg" alt="zhouzhiou" width="28" height="28"/>
    <span class="sr-only">{t('common','sr_home', lang)}</span>
  </a>
  <nav class="hidden md:flex items-center gap-8 text-sm text-[var(--color-muted)]">
    <a href={`/${lang}`}>{t('common','nav_home', lang)}</a>
    <a href={`/${lang}/blog`}>{t('common','nav_blog', lang)}</a>
    <a href={`/${lang}/projects`}>{t('common','nav_projects', lang)}</a>
    <a href={`/${lang}/notes`}>{t('common','nav_notes', lang)}</a>
    <a href={`/${lang}/about`}>{t('common','nav_about', lang)}</a>
    <a href={`/${lang}/contact`}>{t('common','nav_contact', lang)}</a>

    <!-- Right side icons -->
    <!-- search icon removed per request -->
    <LocaleSwitcher lang={lang} path={Astro.url.pathname} />
    <button aria-label={t('common','toggle_theme', lang)} id="theme-toggle" class="text-lg hover:text-[var(--color-fg)] flex items-center justify-center w-6 h-6">
      <!-- Sun icon -->
      <svg id="icon-sun" class="hidden" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 6.95l-1.414-1.414M6.464 6.464 5.05 5.05m12.9 0-1.414 1.414M6.464 17.536 5.05 18.95"/></svg>
      <!-- Moon icon -->
      <svg id="icon-moon" class="hidden" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 0111.21 3 7 7 0 1019 12.79z"/></svg>
    </button>
  </nav>

  <!-- Mobile actions: theme + hamburger -->
  <div class="md:hidden flex items-center gap-3">
    <button aria-label={t('common','toggle_theme', lang)} id="theme-toggle-2" class="text-lg hover:text-[var(--color-fg)] flex items-center justify-center w-6 h-6">
      <svg id="icon-sun-2" class="hidden" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 6.95l-1.414-1.414M6.464 6.464 5.05 5.05m12.9 0-1.414 1.414M6.464 17.536 5.05 18.95"/></svg>
      <svg id="icon-moon-2" class="hidden" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 0111.21 3 7 7 0 1019 12.79z"/></svg>
    </button>
    <button id="menu-toggle" aria-haspopup="menu" aria-expanded="false" aria-label={t('common','nav_all_pages', lang)} class="inline-flex items-center justify-center w-8 h-8 rounded hover:bg-black/5 dark:hover:bg-white/5">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>
  </div>

  <!-- Mobile menu panel -->
  <div id="mobile-menu" role="menu" aria-labelledby="menu-toggle" class="md:hidden hidden absolute right-0 top-full mt-2 min-w-[200px] rounded-lg border border-[var(--color-border)] bg-[var(--color-bg-soft)] p-2 text-sm shadow-sm dark:shadow-glow z-50">
    <a class="block rounded px-3 py-2 hover:bg-black/5 dark:hover:bg-white/5" href={`/${lang}`}>{t('common','nav_home', lang)}</a>
    <a class="block rounded px-3 py-2 hover:bg-black/5 dark:hover:bg-white/5" href={`/${lang}/blog`}>{t('common','nav_blog', lang)}</a>
    <a class="block rounded px-3 py-2 hover:bg-black/5 dark:hover:bg-white/5" href={`/${lang}/projects`}>{t('common','nav_projects', lang)}</a>
    <a class="block rounded px-3 py-2 hover:bg-black/5 dark:hover:bg-white/5" href={`/${lang}/notes`}>{t('common','nav_notes', lang)}</a>
    <a class="block rounded px-3 py-2 hover:bg-black/5 dark:hover:bg-white/5" href={`/${lang}/about`}>{t('common','nav_about', lang)}</a>
    <a class="block rounded px-3 py-2 hover:bg-black/5 dark:hover:bg-white/5" href={`/${lang}/contact`}>{t('common','nav_contact', lang)}</a>
    <div class="my-1 border-t border-[var(--color-border)]"></div>
    <div class="px-3 py-1 text-[var(--color-muted)]">Language</div>
    <div class="flex gap-1 px-2 pb-2">
      <a class="flex-1 text-center rounded px-3 py-2 hover:bg-black/5 dark:hover:bg-white/5" href={pathWithLocale('en', currentPath)}>{t('common','lang_en','en')}</a>
      <a class="flex-1 text-center rounded px-3 py-2 hover:bg-black/5 dark:hover:bg-white/5" href={pathWithLocale('zh', currentPath)}>{t('common','lang_zh','zh')}</a>
    </div>
  </div>

  <!-- Backdrop for mobile menu -->
  <div id="mobile-backdrop" class="md:hidden hidden fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>

  <script>
    const themeKey = 'theme';
    const prefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;
    const stored = localStorage.getItem(themeKey);
    const html = document.documentElement;
    const btn1 = document.getElementById('theme-toggle');
    const sun1 = document.getElementById('icon-sun');
    const moon1 = document.getElementById('icon-moon');
    const btn2 = document.getElementById('theme-toggle-2');
    const sun2 = document.getElementById('icon-sun-2');
    const moon2 = document.getElementById('icon-moon-2');

    function setTheme(t){
      if(t === 'light'){
        html.classList.remove('dark');
        sun1?.classList.add('hidden');
        moon1?.classList.remove('hidden');
        sun2?.classList.add('hidden');
        moon2?.classList.remove('hidden');
      }else{
        html.classList.add('dark');
        moon1?.classList.add('hidden');
        sun1?.classList.remove('hidden');
        moon2?.classList.add('hidden');
        sun2?.classList.remove('hidden');
      }
    }

    const initial = stored ?? (prefersLight ? 'light' : 'dark');
    setTheme(initial);

    function toggleTheme(){
      const next = html.classList.contains('dark') ? 'light':'dark';
      localStorage.setItem(themeKey, next);
      setTheme(next);
    }
    btn1?.addEventListener('click', toggleTheme);
    btn2?.addEventListener('click', toggleTheme);

    // Mobile menu toggle
    const menuBtn = document.getElementById('menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    const mobileBackdrop = document.getElementById('mobile-backdrop');
    function openMenu(v){
      if(!mobileMenu || !menuBtn) return;
      if(v){
        mobileMenu.classList.remove('hidden');
        menuBtn.setAttribute('aria-expanded','true');
      }else{
        mobileMenu.classList.add('hidden');
        mobileBackdrop?.classList.add('hidden');
        menuBtn.setAttribute('aria-expanded','false');
      }
    }
    let shown = false;
    menuBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); shown=!shown; if(shown){ mobileBackdrop?.classList.remove('hidden'); } openMenu(shown); });
    mobileMenu?.addEventListener('click', (e)=>{ const t = e.target; if(t && t.tagName === 'A') { shown=false; openMenu(false); } });
    mobileBackdrop?.addEventListener('click', ()=>{ shown=false; openMenu(false); });
    window.addEventListener('click', ()=>{ shown=false; openMenu(false); });

    // Search shortcuts moved to SearchButton to limit to article pages only
  </script>
