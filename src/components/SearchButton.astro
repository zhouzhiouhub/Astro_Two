---
import { t, type Locale } from "@/lib/i18n";
const { lang } = Astro.props as { lang: Locale };
---
<button data-article-search data-search-lang={lang}
  class="inline-flex items-center gap-2 rounded-md border border-[var(--color-border)] bg-[var(--color-bg-soft)] px-3 py-2 text-sm hover:bg-black/5 dark:hover:bg-white/5"
  aria-label={t('common','search', lang)}>
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
  <span>{t('common','search', lang)}</span>
</button>

<script>
  (function(){
    function resolveLang(source){
      if (source && typeof source === 'object' && 'dataset' in source) {
        const value = source.dataset?.searchLang;
        if (typeof value === 'string' && value.trim()) return value;
      }
      const docLang = document.documentElement?.getAttribute('lang');
      return (docLang && docLang.trim()) || 'en';
    }

    function openSearch(locale){
      const ev = new CustomEvent('open-search', { detail: { lang: locale } });
      window.dispatchEvent(ev);
    }

    const buttons = Array.from(document.querySelectorAll('button[data-article-search]'));
    const fallbackLang = resolveLang(buttons[0] ?? null);

    buttons.forEach((btn) => {
      const currentLang = resolveLang(btn);
      btn.addEventListener('click', (event) => {
        event.preventDefault();
        openSearch(currentLang);
      });
    });

    if (!window._articleSearchKeysBound) {
      window._articleSearchKeysBound = true;
      window.addEventListener('keydown', (event) => {
        if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'k') {
          event.preventDefault();
          openSearch(fallbackLang);
        }
        if (!event.ctrlKey && !event.metaKey && event.key === '/' && (document.activeElement === document.body)) {
          event.preventDefault();
          openSearch(fallbackLang);
        }
      });
    }
  })();
</script>
