---
import qqSvg from '@/assets/qq.svg?raw';
import wechatSvg from '@/assets/weixin.svg?raw';
import discordSvg from '@/assets/discord.svg?raw';
import youtubeSvg from '@/assets/youtube-icon.svg?raw';
import githubSvg from '@/assets/cib-github.svg?raw';
import weiboSvg from '@/assets/weibo-fill.svg?raw';
import linkedinSvg from '@/assets/cib-linkedin.svg?raw';
import xSvg from '@/assets/twitter.svg?raw';
import facebookSvg from '@/assets/facebook.svg?raw';
import { t } from '@/lib/i18n';
import { localeHref, withBase } from '@/lib/url';

const { lang = 'en' } = Astro.props as { lang?: string };
const year = new Date().getFullYear();
const icp = (import.meta as any).env?.SITE_ICP as string | undefined;
const localized = {
  home: localeHref(lang),
  blog: localeHref(lang, '/blog'),
  about: localeHref(lang, '/about'),
  contact: localeHref(lang, '/contact'),
  categoriesTags: localeHref(lang, '/categories-tags'),
  projects: localeHref(lang, '/projects'),
  notes: localeHref(lang, '/notes'),
  essays: localeHref(lang, '/essays'),
  research: localeHref(lang, '/research'),
  archive: localeHref(lang, '/archive'),
  blogroll: localeHref(lang, '/blogroll'),
  references: localeHref(lang, '/references'),
  opensource: localeHref(lang, '/opensource'),
  privacy: localeHref(lang, '/privacy'),
  terms: localeHref(lang, '/terms'),
};
const logoSrc = withBase('/logo.svg');
const rssHref = withBase('/rss.xml');

function normalizeSvg(raw: string) {
  let s = raw
    .replace(/<\?xml[\s\S]*?\?>/gi, '')
    .replace(/<!--([\s\S]*?)-->/g, '')
    .replace(/<title[^>]*>[\s\S]*?<\/title>/gi, '')
    .replace(/<rect[^>]*width=["']\s*24\s*["'][^>]*height=["']\s*24\s*["'][^>]*\/>/gi, '')
    .replace(/<rect[^>]*x=["']0["'][^>]*y=["']0["'][^>]*\/>/gi, '')
    .replace(/<svg([^>]*)>/i, (m, attrs) => {
      const cleaned = attrs
        .replace(/\s(fill|stroke)=["'][^"']+["']/gi, '')
        .replace(/\s(width|height)=["'][^"']+["']/gi, '');
      return `<svg${cleaned}>`;
    })
    .replace(/fill=["'](?!none)[^"']+["']/gi, 'fill="currentColor"')
    .replace(/stroke=["'](?!none)[^"']+["']/gi, 'stroke="currentColor"');

  s = s.replace(/<(path|circle|ellipse|polygon|rect)\b([^>]*)(?<![\/]>)\/?>(?!<\/\1>)/gi, (m) => {
    if (/\s(fill|stroke)=/i.test(m)) return m;
    return m.replace(/\/?>(?=$)/, (end) => ` fill="currentColor"${end}`);
  });

  return s;
}

const links = [
  { label: 'QQ', svg: normalizeSvg(qqSvg), href: '#', scale: 0.9 },
  { label: 'WeChat', svg: normalizeSvg(wechatSvg), href: '#', scale: 0.9 },
  { label: 'Discord', svg: normalizeSvg(discordSvg), href: '#', scale: 0.9 },
  { label: 'YouTube', svg: normalizeSvg(youtubeSvg), href: '#', scale: 0.96 },
  { label: 'GitHub', svg: normalizeSvg(githubSvg), href: '#', scale: 0.96 },
  { label: 'Weibo', svg: normalizeSvg(weiboSvg), href: '#', scale: 0.9 },
  { label: 'LinkedIn', svg: normalizeSvg(linkedinSvg), href: '#', scale: 0.94 },
  { label: 'X', svg: normalizeSvg(xSvg), href: '#', scale: 0.94 },
  { label: 'Facebook', svg: normalizeSvg(facebookSvg), href: '#', scale: 0.94 },
];
---
<footer class="container relative overflow-hidden pt-6 pb-12 border-t border-[var(--color-border)] mt-16">
  <!-- soft radial glow background -->
  <div aria-hidden="true" class="pointer-events-none absolute inset-0 -z-10 [background:radial-gradient(60%_40%_at_10%_0%,rgba(255,255,255,0.06),transparent_60%),radial-gradient(50%_30%_at_90%_0%,rgba(255,255,255,0.05),transparent_60%)]"></div>

  <!-- top brand + tagline -->
  <div class="flex items-center justify-between mb-6">
    <a href={localized.home} class="inline-flex items-center gap-3">
      <img src={logoSrc} alt="logo" class="h-10 w-10 md:h-12 md:w-12" />
      <span class="sr-only">Home</span>
    </a>
    <p class="hidden md:block text-[var(--color-muted)]">{t('footer','tagline', lang)}</p>
  </div>
  <!-- Navigation columns -->
  <div class="mt-6 grid grid-cols-2 gap-x-16 gap-y-10 text-base lg:grid-cols-[auto_auto_auto_auto] lg:justify-between">
    <!-- 1: 关于 / About -->
    <div>
      <div class="text-[var(--color-fg)] font-semibold text-lg">{t('footer','col_about', lang)}</div>
      <ul class="mt-4 space-y-2 text-[var(--color-muted)] leading-7">
        <li><a class="hover:text-[var(--color-fg)]" href={localized.about}>{t('footer','about_me', lang)}</a></li>
        <li><a class="hover:text-[var(--color-fg)]" href={localized.blog}>{t('footer','blog_philosophy', lang)}</a></li>
        <li><a class="hover:text-[var(--color-fg)]" href={localized.contact}>{t('footer','contact', lang)}</a></li>
        <li><a class="hover:text-[var(--color-fg)]" href="#subscribe">{t('footer','subscribe', lang)}</a></li>
      </ul>
    </div>

    <!-- 2: 内容 / Content -->
    <div>
      <div class="text-[var(--color-fg)] font-semibold text-lg">{t('footer','col_content', lang)}</div>
      <ul class="mt-4 space-y-2 text-[var(--color-muted)] leading-7">
        <li><a class="hover:text-[var(--color-fg)]" href={localized.home}>{t('footer','home', lang)}</a></li>
        <li><a class="hover:text-[var(--color-fg)]" href={localized.blog}>{t('footer','all_posts', lang)}</a></li>
        <li><a class="hover:text-[var(--color-fg)]" href={localized.categoriesTags}>{t('footer','categories_tags', lang)}</a></li>
        <li><a class="hover:text-[var(--color-fg)]" href={localized.projects}>{t('footer','projects', lang)}</a></li>
      </ul>
    </div>

    <!-- 3: 创作 / Creative -->
    <div>
      <div class="text-[var(--color-fg)] font-semibold text-lg">{t('footer','col_creative', lang)}</div>
      <ul class="mt-4 space-y-2 text-[var(--color-muted)] leading-7">
        <li><a class="hover:text-[var(--color-fg)]" href={localized.notes}>{t('footer','notes_ideas', lang)}</a></li>
        <li><a class="hover:text-[var(--color-fg)]" href={localized.essays}>{t('footer','essays_inspirations', lang)}</a></li>
        <li><a class="hover:text-[var(--color-fg)]" href={localized.research}>{t('footer','research_experiments', lang)}</a></li>
        <li><a class="hover:text-[var(--color-fg)]" href={localized.archive}>{t('footer','writing_archive', lang)}</a></li>
      </ul>
    </div>

    <!-- 4: 资源 / Resources -->
    <div>
      <div class="text-[var(--color-fg)] font-semibold text-lg">{t('footer','col_resources', lang)}</div>
      <ul class="mt-4 space-y-2 text-[var(--color-muted)] leading-7">
        <li><a class="hover:text-[var(--color-fg)]" href={rssHref} target="_blank" rel="noopener noreferrer">{t('footer','rss', lang)}</a></li>
        <li><a class="hover:text-[var(--color-fg)]" href={localized.blogroll}>{t('footer','blogroll', lang)}</a></li>
        <li><a class="hover:text-[var(--color-fg)]" href={localized.references}>{t('footer','references', lang)}</a></li>
        <li><a class="hover:text-[var(--color-fg)]" href={localized.opensource}>{t('footer','opensource', lang)}</a></li>
      </ul>
    </div>
  </div>

  <!-- Social icons row (moved below nav) -->
  <div class="mt-6 flex items-center justify-between">
    <p class="text-sm text-[var(--color-muted)]">{t('footer','connect', lang)}</p>
    <ul class="flex flex-wrap items-center gap-3 md:gap-4 justify-end">
    {links.map((l) => (
      <li>
        <a class="group inline-flex h-10 w-10 md:h-12 md:w-12 items-center justify-center overflow-hidden rounded-xl bg-transparent hover:bg-transparent transition text-[var(--color-muted)] hover:text-[var(--color-fg)]" href={l.href} target="_blank" rel="noopener noreferrer" aria-label={l.label} title={l.label}>
          <span style={`--s:${l.scale ?? 0.9}`} class="h-full w-full opacity-90 group-hover:opacity-100 [&>svg]:h-full [&>svg]:w-full [&>svg]:[transform:scale(var(--s))] [&>svg]:[transform-origin:center]" aria-hidden="true" set:html={l.svg} />
          <span class="sr-only">{l.label}</span>
        </a>
      </li>
    ))}
    </ul>
  </div>

  <!-- Bottom meta row -->
  <div class="mt-12 flex flex-col md:flex-row md:items-center gap-3 md:gap-6 justify-between text-base text-[var(--color-muted)]">
    <div>
      {lang === 'zh' && icp ? (
        <a href="https://beian.miit.gov.cn" target="_blank" rel="noopener noreferrer" class="hover:text-[var(--color-fg)]">{icp}</a>
      ) : (
        <span>&copy; {year}</span>
      )}
    </div>
    <div class="flex items-center gap-4 self-end md:self-auto">
      <a href={localized.privacy} class="hover:text-[var(--color-fg)]">{t('common','privacy', lang)}</a>
      <span class="opacity-40">&bull;</span>
      <a href={localized.terms} class="hover:text-[var(--color-fg)]">{t('common','terms', lang)}</a>
    </div>
  </div>
</footer>
