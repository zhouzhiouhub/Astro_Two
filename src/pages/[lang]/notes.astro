---
import Base from "@/layouts/BaseLayout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import SearchButton from "@/components/SearchButton.astro";
import { t, isLocale } from "@/lib/i18n";
import { localeHref } from "@/lib/url";
import { notesByLocale } from "@/data/notes";

export async function getStaticPaths() {
  return [
    { params: { lang: "en" } },
    { params: { lang: "zh" } },
  ];
}
export const prerender = true;

const { lang } = Astro.params;
if (!lang || !isLocale(lang)) { throw new Error("Invalid locale"); }
const title = t("notes", "title", lang);
const subtitle = t("notes", "subtitle", lang);
const url = Astro.url.href;
const allNotes = notesByLocale[lang];
const noteHref = (slug: string) => localeHref(lang, `/notes/${slug}`);
---
<Base title={title} desc={subtitle} url={url} lang={lang}>
  <Header lang={lang} />
  <main class="container py-12">
    <div class="mb-4 flex justify-end"><SearchButton lang={lang} /></div>
    <h1 class="text-3xl font-semibold">{title}</h1>
    <p class="mt-2 text-[var(--color-muted)]">{subtitle}</p>
    <p class="mt-4 text-sm text-[var(--color-muted)]">{t('notes','intro', lang)}</p>

    <section class="mt-8 grid gap-6 md:grid-cols-2">
      {allNotes.map((note) => {
        const anchorId = `${note.id}-${lang}`;
        const description = note.summary;
        const keywords = [note.title, note.summary, note.tags.join(' '), note.updatedAt].join(' ');
        return (
        <article
          id={anchorId}
          data-search-item
          data-search-title={note.title}
          data-search-anchor={anchorId}
          data-search-description={description}
          data-search-keywords={keywords}
          data-tags={note.tags.join(',')}
          data-search-link={note.link ?? ''}
          class="card flex h-full flex-col gap-4 p-6 hover:border-[var(--color-primary)] transition-colors cursor-pointer"
          onclick={`window.location.href='${noteHref(note.slug)}'`}
        >
          <div class="flex items-center justify-between text-xs text-[var(--color-muted)]">
            <span>{t('notes','updated_label', lang)} {note.updatedAt}</span>
            <div class="flex flex-wrap gap-2">
              {note.tags.map((tag) => (
                <span class="rounded-full border border-[var(--color-border)] px-3 py-1">#{tag}</span>
              ))}
            </div>
          </div>
          <div class="space-y-2">
            <h2 class="text-lg font-semibold">{note.title}</h2>
            <p class="text-sm text-[var(--color-muted)] leading-relaxed">{note.summary}</p>
          </div>
          <div class="mt-auto flex items-center justify-between">
            <a href={noteHref(note.slug)} class="inline-flex items-center gap-2 text-sm text-[var(--color-primary)]" onclick="event.stopPropagation()">
              {t('notes','view_detail', lang)}
              <span aria-hidden="true">→</span>
            </a>
            {note.link && (
              <a href={note.link} class="inline-flex items-center gap-2 text-sm text-[var(--color-muted)] hover:text-[var(--color-primary)]" target="_blank" rel="noopener" onclick="event.stopPropagation()">
                GitHub
                <span aria-hidden="true">↗</span>
              </a>
            )}
          </div>
        </article>
      );})}
    </section>
    <Footer lang={lang} />
  </main>
</Base>
