---
import Base from "@/layouts/BaseLayout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import SearchButton from "@/components/SearchButton.astro";
import { t, isLocale } from "@/lib/i18n";
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  return [
    { params: { lang: "en" } },
    { params: { lang: "zh" } },
  ];
}
export const prerender = true;

const { lang } = Astro.params;
if (!lang || !isLocale(lang)) { throw new Error("Invalid locale"); }
const title = t("blog", "title", lang);
const subtitle = t("blog", "subtitle", lang);
const url = Astro.url.href;
const posts = (await getCollection('posts'))
  .filter(p => p.data.locale === lang)
  .sort((a,b) => new Date(b.data.date as any).getTime() - new Date(a.data.date as any).getTime());
const emptyText = (() => { const v = t('blog','empty', lang); return v === 'empty' ? (lang === 'zh' ? '暂无文章。' : 'No posts yet.') : v; })();
---
<Base title={title} desc={subtitle} url={url} lang={lang}>
  <Header lang={lang} />
  <main class="container py-12">
    <div class="mb-4 flex justify-end"><SearchButton lang={lang} /></div>
    <h1 class="text-3xl font-semibold">{title}</h1>
    <p class="mt-2 text-[var(--color-muted)]">{subtitle}</p>
    <section class="mt-8 space-y-6">
      {posts.length === 0 && (
        <div class="text-[var(--color-muted)] text-sm">{emptyText}</div>
      )}
      {posts.map((p) => {
        const d = typeof p.data.date === 'string' ? p.data.date : new Date(p.data.date).toISOString().slice(0,10);
        return (
          <a href={`/${lang}/blog/${p.data.slugBase}`} class="block rounded-lg border border-[var(--color-border)] p-4 hover:border-[var(--color-fg)] transition-colors">
            <div class="text-sm text-[var(--color-muted)]">{d}</div>
            <div class="mt-1 text-lg font-semibold">{p.data.title}</div>
            {p.data.description && <div class="mt-1 text-[var(--color-muted)]">{p.data.description}</div>}
          </a>
        );
      })}
    </section>

    <Footer lang={lang} />
  </main>
</Base>
