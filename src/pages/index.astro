---
import { SUPPORTED_LOCALES, defaultLocale } from "@/lib/i18n";
import siteConfig from "@/config/config.json" assert { type: "json" };
export const prerender = true;

// Get base URL for proper path construction
const base = import.meta.env.BASE_URL || '/';
const baseWithoutTrailingSlash = base.replace(/\/$/, '');
const assetPath = (value: string) => {
  const trimmed = value.replace(/^\//, '');
  return `${baseWithoutTrailingSlash}/${trimmed}`.replace(/\/+/, '/');
};
const supportedLocales = Array.from(SUPPORTED_LOCALES);
const trailingSlashEnabled = Boolean(siteConfig?.site?.trailing_slash);
const localeSuffix = trailingSlashEnabled ? '/' : '';
const localeHref = (lang: string) => `${baseWithoutTrailingSlash}/${lang}${localeSuffix}`;
---

<!DOCTYPE html>
<html lang={defaultLocale} data-base-path={baseWithoutTrailingSlash || undefined}>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title></title>
  
  <!-- Language Detection Core Module -->
  <script is:inline src={assetPath('lang-detect-core.js')}></script>
  
  <!-- Root Path Redirect -->
  <script is:inline define:vars={{ baseUrl: baseWithoutTrailingSlash, supportedLocales, defaultLocale, localeSuffix }}>
    // Root path redirect - immediate and silent
    (function() {
      'use strict';
      
      try {
        if (typeof LangDetectCore === 'undefined') {
          throw new Error('LangDetectCore not loaded');
        }
        
        const { LangDetector } = LangDetectCore;
        const targetLang = LangDetector.getTargetLang();
        const href = baseUrl ? baseUrl + '/' + targetLang + localeSuffix : '/' + targetLang + localeSuffix;
        window.location.replace(href);
      } catch (error) {
        // Fallback: minimal redirect logic
        var stored = null;
        try { stored = localStorage.getItem('lang'); } catch {}
        var supported = supportedLocales;
        var def = defaultLocale;
        var makeHref = function(lang) {
          var basePart = baseUrl ? baseUrl + '/' + lang : '/' + lang;
          return basePart + localeSuffix;
        };
        
        if (stored && supported.indexOf(stored) !== -1) {
          window.location.replace(makeHref(stored));
          return;
        }
        
        var langs = navigator.languages || [navigator.language];
        for (var i = 0; i < langs.length; i++) {
          var primary = String(langs[i] || '').toLowerCase().split('-')[0];
          if (supported.indexOf(primary) !== -1) {
            window.location.replace(makeHref(primary));
            return;
          }
        }
        window.location.replace(makeHref(def));
      }
    })();
  </script>
  
  <!-- Fallback meta redirect if JavaScript is disabled -->
  <meta http-equiv="refresh" content={`0; url=${localeHref(defaultLocale)}`}>
</head>
<body style="margin: 0; background: #fff;">
  <!-- Silent redirect, no visible content -->
  
  <!-- Fallback for no JavaScript -->
  <noscript>
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; padding: 32px;">
      <p style="margin: 0 0 16px; color: #333; font-family: system-ui, -apple-system, sans-serif;">Please select your language:</p>
      <a href={localeHref('en')} style="display: inline-block; margin: 8px; padding: 12px 24px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-family: system-ui, -apple-system, sans-serif;">English</a>
      <a href={localeHref('zh')} style="display: inline-block; margin: 8px; padding: 12px 24px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-family: system-ui, -apple-system, sans-serif;">中文</a>
    </div>
  </noscript>
</body>
</html>
